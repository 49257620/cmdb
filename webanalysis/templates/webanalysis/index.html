{% extends "base.html" %}
{% load static %}
{% block title %} 日志分析 {% endblock %}
{% block link %}
    <link href="{% static 'js/echart27/asset/css/echartsHome.css' %}" rel="stylesheet">
{% endblock %}
{% block content%}
    <div class="row" >
        <div class="col-lg-12" >
            <div class="ibox float-e-margins" >
                <div class="ibox-title">
                    <h5>日志分析-上传 </h5>
                    <div class="ibox-tools">
                    </div>
                </div>
                <div class="ibox-content">
                    <form method="post" id="file_upload_form" enctype="multipart/form-data"  action="{% url 'webanalysis:upload' %}" class="form-horizontal">
                        {% csrf_token %}
                        <div class="row">
                            <div class="form-group col-sm-11">
                                <label class="col-sm-4 control-label">上传文件</label>
                                <div class="col-sm-6">
                                    <input type="file" placeholder="请上传文件" name="log_file" value="" required class="form-control">
                                </div>
                                <div class="col-sm-2">
                                    <button type="submit" class="btn btn-primary">上传</button>
                                    <button type="button" class="btn btn-warning" id="sync_ip_btn">同步IP</button>
                                </div>
                            </div>

                        </div>

                    </form>
                </div>
            </div>
            <div class="ibox float-e-margins" >
                <div class="ibox-title">
                    <h5>日志分析-图表 <small id="file_name"></small> </h5>
                    <div class="ibox-tools">
                        <a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
                            <i class="fa fa-search"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-user" id="memuselect">
                            {%  for item in files  %}
                                <li data-id="{{ item.id }}"><a href="javascript:void(0)"  >{{ item.name }}</a></li>
                            {% endfor %}
                        </ul>

                    </div>
                </div>
                <div class="ibox-content">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <h5>返回代码</h5>
                                    <div class="ibox-tools">

                                    </div>
                                </div>
                                <div class="ibox-content">
                                        <div class="flot-chart main" id="chart1"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <h5>每日访问量</h5>
                                    <div class="ibox-tools">

                                    </div>
                                </div>
                                <div class="ibox-content">
                                        <div class="flot-chart main" id="chart2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="ibox float-e-margins">
                                <div class="ibox-title">
                                    <h5>地图</h5>
                                    <div class="ibox-tools">

                                    </div>
                                </div>
                                <div class="ibox-content">
                                        <div class="flot-chart main"  id="chart3"></div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

    </div>
{% endblock %}
{% block dialog %}

{% endblock %}
{% block script %}
        <!-- echart -->

    <script src="{% static 'js/echarts-2.2.7/build/dist/echarts-all.js' %}"></script>
    <!--
    <script src="{% static 'js/echart27/extension/BMap/src/main.js' %}"></script>
    <script src="{% static 'js/echarts-2.2.7/extension/BMap/doc/BMap.js' %}"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ZUONbpqGBsYGXNIYHicvbAbM"></script>
     -->

{% endblock %}
{% block js %}


    //var chart3 = echarts.init(document.getElementById('chart3'));

    var option1 = {
            title : {
                text: '访问状态码',
                subtext: '',
                x:'center'
            },
            tooltip : {
                trigger: 'item',
                formatter: "{a} <br/>{b} : {c} ({d}%)"
            },
            legend: {
                orient : 'vertical',
                x : 'left',
                data:['404','500','200','301']
            },
            toolbox: {
                show : true,
                feature : {

                }
            },
            calculable : true,
            series : [
                {
                    name:'访问状态',
                    type:'pie',
                    radius : '55%',
                    center: ['50%', '60%'],
                    data:[
                        {value:335, name:'404'},
                        {value:310, name:'500'},
                        {value:234, name:'200'},
                        {value:135, name:'301'}
                    ]
                }
            ]
        };
    var option2 = {
            title : {
                text: '每日访问量',
                subtext: ''
            },
            tooltip : {
                trigger: 'axis'
            },
            legend: {
                data:['访问量']
            },
            toolbox: {
                show : true,
                feature : {

                }
            },
            calculable : true,
            xAxis : [
                {
                    type : 'category',
                    data : ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月']
                }
            ],
            yAxis : [
                {
                    type : 'value'
                }
            ],
            series : [
                {
                    name:'访问量',
                    type:'bar',
                    data:[2.0, 4.9, 7.0, 23.2, 25.6, 76.7, 135.6, 162.2, 32.6, 20.0, 6.4, 3.3],

                }
            ]
        };
    var option3 = {
            color: ['gold','aqua','lime'],
            title : {
                text: '模拟迁徙',
                subtext:'数据纯属虚构',
                x:'right'
            },
            tooltip : {
                trigger: 'item',
                formatter: function (v) {
                    return v[1].replace(':', ' > ');
                }
            },
            legend: {
                orient: 'vertical',
                x:'left',
                data:['北京'],
                selectedMode: 'single',
                selected:{

                }
            },
            toolbox: {

            },
            dataRange: {
                min : 0,
                max : 100,
                y: '60%',
                calculable : true,
                color: ['#ff3333', 'orange', 'yellow','lime','aqua']
            },
            series : [
                {
                    name:'北京',
                    type:'map',
                    mapType: 'none',
                    data:[],
                    geoCoord: {

                    },

                    markLine : {
                        smooth:true,
                        effect : {
                            show: true,
                            scaleSize: 1,
                            period: 30,
                            color: '#fff',
                            shadowBlur: 10
                        },
                        itemStyle : {
                            normal: {
                                borderWidth:1,
                                lineStyle: {
                                    type: 'solid',
                                    shadowBlur: 10
                                }
                            }
                        },
                        data : [
                            [{name:'上海'}, {name:'北京',value:115}],
                            [{name:'乌鲁木齐'}, {name:'北京',value:10}],
                            [{name:'兰州'}, {name:'北京',value:71}],
                            [{name:'北京'}, {name:'北京',value:278}],
                            [{name:'南京'}, {name:'北京',value:36}],
                            [{name:'南进'}, {name:'北京',value:26}],
                            [{name:'合肥'}, {name:'北京',value:10}],
                            [{name:'哈尔滨'}, {name:'北京',value:6}],
                            [{name:'嘉兴'}, {name:'北京',value:18}],
                            [{name:'天津'}, {name:'北京',value:21}],
                            [{name:'太原'}, {name:'北京',value:21}],
                            [{name:'宁波'}, {name:'北京',value:10}],
                            [{name:'广州'}, {name:'北京',value:55}],
                            [{name:'成都'}, {name:'北京',value:79}],
                            [{name:'杭州'}, {name:'北京',value:31}],
                            [{name:'武汉'}, {name:'北京',value:26}],
                            [{name:'沈阳'}, {name:'北京',value:6}],
                            [{name:'河北'}, {name:'北京',value:17}],
                            [{name:'济南'}, {name:'北京',value:19}],
                            [{name:'深圳市'}, {name:'北京',value:16}],
                            [{name:'湖陂'}, {name:'北京',value:11}],
                            [{name:'福州市'}, {name:'北京',value:27}],
                            [{name:'西宁'}, {name:'北京',value:9}],
                            [{name:'西安'}, {name:'北京',value:19}],
                            [{name:'贵阳'}, {name:'北京',value:63}],
                            [{name:'郑州'}, {name:'北京',value:89}],
                            [{name:'重庆'}, {name:'北京',value:51}],
                            [{name:'长春'}, {name:'北京',value:14}],
                            [{name:'长沙市'}, {name:'北京',value:14}],
                            [{name:'阿姆斯特丹'}, {name:'北京',value:14}],
                            [{name:'雷德蒙德'}, {name:'北京',value:7}]
                        ]
                    },
                    markPoint : {
                        symbol:'emptyCircle',
                        symbolSize : function (v){
                            return 10 + v/10
                        },
                        effect : {
                            show: true,
                            shadowBlur : 0
                        },
                        itemStyle:{
                            normal:{
                                label:{show:false}
                            }
                        },
                        data : [
                            {name:'上海',value:115},
                            {name:'乌鲁木齐',value:10},
                            {name:'兰州',value:71},
                            {name:'北京',value:278},
                            {name:'南京',value:36},
                            {name:'南进',value:26},
                            {name:'合肥',value:10},
                            {name:'哈尔滨',value:6},
                            {name:'嘉兴',value:18},
                            {name:'天津',value:21},
                            {name:'太原',value:21},
                            {name:'宁波',value:10},
                            {name:'广州',value:55},
                            {name:'成都',value:79},
                            {name:'杭州',value:31},
                            {name:'武汉',value:26},
                            {name:'沈阳',value:6},
                            {name:'河北',value:17},
                            {name:'济南',value:19},
                            {name:'深圳市',value:16},
                            {name:'湖陂',value:11},
                            {name:'福州市',value:27},
                            {name:'西宁',value:9},
                            {name:'西安',value:19},
                            {name:'贵阳',value:63},
                            {name:'郑州',value:89},
                            {name:'重庆',value:51},
                            {name:'长春',value:14},
                            {name:'长沙市',value:14},
                            {name:'阿姆斯特丹',value:14},
                            {name:'雷德蒙德',value:7}
                        ]
                    }

                }
            ]
        };



    function load_pie(id){
        $.get('{% url "webanalysis:pie_data" %}',{id:id},function(result){
            //console.log(result);
            option1['legend']['data'] = result['result']['legend'];
            option1['series'][0]['data'] = result['result']['series'];
            var chart1 = echarts.init(document.getElementById('chart1'));
            chart1.setOption(option1);
        },'json')
    }

    function load_bar(id){
        $.get('{% url "webanalysis:bar_data" %}',{id:id},function(result){
            //console.log(result);
            option2['xAxis'][0]['data'] = result['result']['x'];
            option2['series'][0]['data'] = result['result']['y'];
            var chart2 = echarts.init(document.getElementById('chart2'));
            chart2.setOption(option2);
        },'json')
    }

    function loadData(){
        id = $(this).data('id');
        $('#file_name').text('('+$(this).find('a').html()+')');
        //console.log($(this).find('a').html());
        load_pie(id);
        load_bar(id);
    }

    function syncIps(){
        $.get('{% url "webanalysis:sync_ips" %}',null,function(result){
            alert('同步成功');

        },'json')
    }


    //console.log($('#memuselect').find('li')[0]);
    $($('#memuselect').find('li')).on('click',loadData);
    $('#memuselect').find('li')[0].click();
    $('#sync_ip_btn').on('click',syncIps);


    // 初始化地图
/*
    var BMapExt = new BMapExtension(document.getElementById('chart3'), BMap, require('echarts'), require('zrender'));
    var map = BMapExt.getMap();
    var container = BMapExt.getEchartsContainer();
    var point = new BMap.Point(startPoint.x, startPoint.y);
    map.centerAndZoom(point, 5);
    map.enableScrollWheelZoom(true);

    if (myChart && myChart.dispose) {
        myChart.dispose();
    }
    myChart = BMapExt.initECharts(container, curTheme);
    window.onresize = myChart.resize;
    BMapExt.setOption(option3, true)

*/
{% endblock %}